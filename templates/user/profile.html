{% extends 'layout.html' %}

{% block title %}Edit Profile{% endblock %}

{% block content %}
    <h1>Edit Profile</h1>

    <form id="profileForm">
        <!-- Form elements as before -->
        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" value="{{user.user_username}}" readonly>
        </div>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" value="{{user.user_email}}">
        </div>
        <div class="form-group">
            <label for="first_name">First Name:</label>
            <input type="text" id="first_name" name="first_name" value="{{user.user_first_name}}">
        </div>
        <div class="form-group">
            <label for="last_name">Last Name:</label>
            <input type="text" id="last_name" name="last_name" value="{{user.user_last_name}}">
        </div>
        <div class="form-group">
            <label>Roles:</label>
            <input type="checkbox" id="is_prof" name="is_prof" {%- if user.is_prof -%}checked{%- endif -%}>
            <label for="is_prof" style="display: inline; font-weight: normal;">Professor</label>
            <br>
            <input type="checkbox" id="is_student" name="is_student" {%- if user.is_student -%}checked{%- endif -%}>
            <label for="is_student" style="display: inline; font-weight: normal;">Student</label>
        </div>
        <input type="hidden" id="id" name="id" value="{{user.user_id}}">

        <button class="btn" type="button" id="saveButton">Save Changes</button>
    </form>

<!-- Corrected script tag type and added DOMContentLoaded listener -->
<script type="text/javascript">
    // Function to convert FormData into a JSON object
    function formToJson(form) {
        const formData = new FormData(form);
        const dataObject = {};

        formData.forEach((value, key) => {
            if (form.elements[key].type === 'checkbox') {
                dataObject[key] = form.elements[key].checked;
            } else {
                dataObject[key] = value;
            }
        });

        return dataObject;
    }

    function handleSaveClick() {
        const form = document.getElementById('profileForm');
        const formDataJson = formToJson(form); // Pass the form element to the function
        const userId = formDataJson.id;

        if (!userId) {
            console.error("User ID is missing. Cannot perform PUT request.");
            alert("Error: User ID is missing.");
            return;
        }

        const endpointUrl = `/user/${userId}`;
        console.log("Data to be submitted:", formDataJson);

        fetch(endpointUrl, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formDataJson)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            alert('Profile updated successfully!');
        })
        .catch((error) => {
            console.error('Error during PUT request:', error);
            alert('Failed to update profile. Check the console for details.');
        });
    }

    // This ensures the DOM is fully loaded before trying to find the button
    document.addEventListener('DOMContentLoaded', (event) => {
        const saveButton = document.getElementById('saveButton');
        if (saveButton) {
            saveButton.addEventListener('click', handleSaveClick);
            console.log('Event listener attached to saveButton.');
        } else {
            console.error('saveButton element not found!');
        }
    });
</script>
{% endblock %}